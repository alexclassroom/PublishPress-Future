(()=>{"use strict";var t,e,i,n,o,a,r,s,u,c,l,p,d,g,h,f,b,y,m,x="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},v=function(){function t(t,e){for(var i=0;i<e.length;i++){var n=e[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,i,n){return i&&t(e.prototype,i),n&&t(e,n),e}}();t=window.wp,e=window.postExpiratorPanelConfig,i=t.plugins.registerPlugin,n=t.editPost.PluginDocumentSettingPanel,o=t.components,a=o.PanelRow,r=o.DateTimePicker,s=o.CheckboxControl,u=o.SelectControl,c=o.FormTokenField,l=o.Spinner,p=t.element,d=p.Fragment,g=p.Component,h=t.htmlEntities.decodeEntities,f=lodash,b=f.isEmpty,y=f.keys,m=f.compact,i("postexpirator-sidebar",{render:function(i){function o(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,o);var e=function(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}(this,(o.__proto__||Object.getPrototypeOf(o)).apply(this,arguments));return e.state={categoriesList:[],catIdVsName:[]},t.data.subscribe(e.listenToPostSave.bind(e)),t.hooks.addAction("after_save_post","publishpress-future",(function(){console.log("getExpirationEnabled",e.getExpirationEnabled()),e.saveCurrentPostData()})),e}return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}(o,i),v(o,[{key:"listenToPostSave",value:function(){var e=this.getPostId(),i=this.getIsSavingPost(),n="ppfuture-expiration-"+e+"-isSavingPost";i&&sessionStorage.setItem(n,"1"),i||"1"===sessionStorage.getItem(n)&&(sessionStorage.removeItem(n),t.hooks.doAction("after_save_post","publishpress-future"))}},{key:"getPostType",value:function(){return t.data.select("core/editor").getCurrentPostType()}},{key:"getPostId",value:function(){return t.data.select("core/editor").getCurrentPostId()}},{key:"getIsSavingPost",value:function(){return t.data.select("core/editor").isSavingPost()||t.data.select("core/editor").isAutosavingPost()}},{key:"editPostAttribute",value:function(e,i){var n={};n[e]=i,t.data.dispatch("core/editor").editPost(n)}},{key:"getEditedPostAttribute",value:function(e){return t.data.select("core/editor").getEditedPostAttribute(e)}},{key:"fetchExpirationDataFromApi",value:function(){var e=this;return t.apiFetch({path:"publishpress-future/v1/post-expiration/"+this.getPostId()}).then((function(t){e.editPostAttribute("expirationEnabled",t.enabled),e.editPostAttribute("expirationAction",t.expireType),e.editPostAttribute("expirationDate",t.date),e.editPostAttribute("expirationTerms",t.category),e.editPostAttribute("expirationTaxonomy",t.categoryTaxonomy),e.setState({expirationEnabled:t.enabled,expirationAction:t.expireType,expirationDate:t.date,expirationTerms:t.category,expirationTaxonomy:t.categoryTaxonomy}),console.log("API return",t)}))}},{key:"saveCurrentPostData",value:function(){var e,i=this.state,n=i.expirationEnabled,o=i.expirationDate,a=i.expirationAction,r=i.expirationTerms;console.log(this.state),e=n?{enabled:n,date:o,action:a,terms:r}:{enabled:!1,date:0,action:"",terms:[]},t.apiFetch({path:"publishpress-future/v1/post-expiration/"+this.getPostId(),method:"POST",data:e}).then((function(t){console.log("Future action data saved."),console.log(t)}))}},{key:"componentWillMount",value:function(){this.fetchExpirationDataFromApi().then(this.initialize.bind(this))}},{key:"initialize",value:function(){var i=this,n=this.getPostType(),o=this.getExpirationEnabled(),a=this.getExpirationAction(),r=this.getExpirationTerms(),s=this.getExpirationDate(),u=this.getExpirationTaxonomy();console.log("Initialized",{enabled:o,date:s,expirationAction:a,categories:r,taxonomy:u});var c=[],l=[];!u&&"post"===n||"category"===u?t.apiFetch({path:t.url.addQueryArgs("wp/v2/categories",{per_page:-1})}).then((function(t){t.forEach((function(t){c[t.name]=t,l[t.id]=t.name})),i.setState({categoriesList:c,catIdVsName:l,taxonomy:e.strings.category})})):t.apiFetch({path:t.url.addQueryArgs("wp/v2/taxonomies/"+u,{context:"edit"})}).then((function(e){t.apiFetch({path:t.url.addQueryArgs("wp/v2/"+e.rest_base,{context:"edit"})}).then((function(t){t.forEach((function(t){c[h(t.name)]=t,l[t.id]=h(t.name)})),i.setState({categoriesList:c,catIdVsName:l,taxonomy:h(e.name)})}))}))}},{key:"componentDidUpdate",value:function(){var t=this.state,e=t.expirationEnabled,i=t.expirationDate,n=t.expirationAction,o=t.expirationTerms;switch(t.attribute){case"enabled":this.editPostAttribute("expirationEnabled",e);break;case"date":this.editPostAttribute("expirationDate",i);break;case"action":this.editPostAttribute("expirationAction",n),n.includes("category")||this.editPostAttribute("expirationTerms",[]);break;case"category":this.editPostAttribute("expirationTerms",o)}}},{key:"getExpirationEnabled",value:function(){return 1==this.getEditedPostAttribute("expirationEnabled")}},{key:"getExpirationDate",value:function(){var t=parseInt(this.getEditedPostAttribute("expirationDate"));t||(t=e.default_date?parseInt(e.default_date):(new Date).getTime());var i=new Date;return i.setTime(1e3*t),i.getTime()/1e3}},{key:"getExpirationAction",value:function(){return this.getEditedPostAttribute("expirationAction")||(e&&e.defaults&&e.defaults.expireType?e.defaults.expireType:"draft")}},{key:"arrayIsEmpty",value:function(t){return!t||0===t.length||""===t[0]}},{key:"getExpirationTerms",value:function(){var t=this.getEditedPostAttribute("expirationTerms",!0),i=e.defaults.terms?e.defaults.terms.split(","):[];return this.arrayIsEmpty(t)?i:t&&void 0!==t&&"object"!==(void 0===t?"undefined":x(t))?[t]:t}},{key:"getExpirationTaxonomy",value:function(){return this.getEditedPostAttribute("expirationTaxonomy")||(e&&e.defaults&&e.defaults.taxonomy?e.defaults.taxonomy:"category")}},{key:"selectCategories",value:function(t){var e=this.state,i=e.categoriesList;if(e.catIdVsName,!t.some((function(t){return"string"==typeof t&&!i[t]})))return t.map((function(t){return"string"==typeof t?i[t]:t})).map((function(t){return t.id}))}},{key:"onChangeEnabled",value:function(t){this.setState({expirationEnabled:t,attribute:"enabled"}),this.editPostAttribute("expirationEnabled",t),console.log(t)}},{key:"onChangeDate",value:function(t){var e=new Date(t).getTime()/1e3;this.setState({expirationDate:e,attribute:"date"}),this.editPostAttribute("expirationDate",e),console.log("New date",e,new Date(1e3*e)),console.log("Getdate",this.getExpirationDate())}},{key:"onChangeAction",value:function(t){this.setState({expirationAction:t,attribute:"action"}),this.editPostAttribute("expirationAction",t)}},{key:"onChangeTerms",value:function(t){this.setState({expirationTerms:this.selectCategories(t),attribute:"category"}),this.editPostAttribute("expirationTerms",t)}},{key:"render",value:function(){var t=this.state,i=t.categoriesList,o=t.catIdVsName,p=this.state,g=p.expirationEnabled,h=p.expirationDate,f=p.expirationAction,x=p.expirationTerms,v=p.expirationTaxonomy,E=x&&m(x.map((function(t){return o[t]||!1})));return"string"==typeof E&&(E=[]),React.createElement(n,{title:e.strings.postExpirator,icon:"calendar",initialOpen:g,className:"post-expirator-panel"},React.createElement(a,null,React.createElement(s,{label:e.strings.enablePostExpiration,checked:g,onChange:this.onChangeEnabled.bind(this)})),g&&React.createElement(d,null,React.createElement(a,null,React.createElement(r,{currentDate:1e3*h,onChange:this.onChangeDate.bind(this),is12Hour:e.is_12_hours})),React.createElement(u,{label:e.strings.howToExpire,value:f,options:e.actions_options,onChange:this.onChangeAction.bind(this)}),f.includes("category")&&(b(y(i))&&React.createElement(d,null,e.strings.loading+" ("+v+")",React.createElement(l,null))||React.createElement(c,{label:e.strings.expirationCategories+" ("+v+")",value:E,suggestions:Object.keys(i),onChange:this.onChangeTerms.bind(this),maxSuggestions:10}))))}}]),o}(g)})})();
//# sourceMappingURL=gutenberg-panel.js.map